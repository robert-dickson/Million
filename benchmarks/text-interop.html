<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.jsdelivr.net/combine/npm/lodash@4.17.21,npm/platform@1.3.6,npm/benchmark@2.1.4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/snabbdom/0.7.4/snabbdom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/virtual-dom@2.1.1/dist/virtual-dom.min.js"></script>
    <script src="../dist/million.js"></script>
  </head>
  <body>
    <div id="app"></div>

    <script>
      const { m, _, patch } = Million;
      const { h, init } = snabbdom;
      const snabPatch = init([]);
      let snabVDomBefore = h(
        'div',
        {
          id: 'app',
        },
        [],
      );
      let vDomBefore;

      const suite = new Benchmark.Suite();

      suite
        .add('million', {
          setup() {
            document.body.innerHTML = '<div id="app"></div>';
          },
          fn() {
            patch(m('div', { id: 'app' }, [String(Date.now())]), document.querySelector('#app'));
          },
        })
        .add('virtual-dom', {
          setup() {
            document.body.innerHTML = '<div id="app"></div>';
          },
          fn() {
            const { diff, patch, h } = virtualDom;
            const newVal = String(Date.now());
            const patches = diff(
              h(
                'div',
                {
                  id: 'app',
                },
                [vDomBefore],
              ),
              h(
                'div',
                {
                  id: 'app',
                },
                [newVal],
              ),
            );
            vDomBefore = newVal;
            patch(document.querySelector('#app'), patches);
          },
        })
        .add('snabbdom', {
          setup() {
            document.body.innerHTML = '<div id="app"></div>';
            snabPatch(document.body.firstChild, snabVDomBefore);
            document.body.firstChild._ = snabVDomBefore;
          },
          fn() {
            const newVal = String(Date.now());
            const newVNode = h(
              'div',
              {
                id: 'app',
              },
              [newVal],
            );
            snabPatch(document.body.firstChild._, newVNode);
            document.body.firstChild._ = newVNode;
          },
        })
        .add('vanilla', {
          setup() {
            document.body.innerHTML = '<div id="app"></div>';
          },
          fn() {
            const textNode = document.createTextNode(String(Date.now()));
            if (document.querySelector('#app').firstChild) {
              document.querySelector('#app').firstChild.replaceWith(textNode);
            } else {
              document.querySelector('#app').appendChild(textNode);
            }
          },
        })
        .add('raw', {
          setup() {
            document.body.innerHTML = '<div id="app"></div>';
          },
          fn() {
            document.querySelector('#app').textContent = String(Date.now());
          },
        })
        .on('cycle', ({ target }) => {
          console.log(String(target));
        })
        .on('complete', function () {
          console.log(`Fastest is ${this.filter('fastest').map('name')}`);
        })
        .run({ async: true });
    </script>
  </body>
</html>
